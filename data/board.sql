CREATE DATABASE IF NOT EXISTS board DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE board;

CREATE TABLE IF NOT EXISTS boards (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(120) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS columns (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  board_id BIGINT NOT NULL,
  name VARCHAR(120) NOT NULL,
  ord INT NOT NULL,
  type ENUM('INITIAL','PENDING','FINAL','CANCEL') NOT NULL,
  CONSTRAINT fk_columns_board FOREIGN KEY (board_id) REFERENCES boards(id) ON DELETE CASCADE,
  CONSTRAINT uq_board_ord UNIQUE(board_id, ord)
);

CREATE TABLE IF NOT EXISTS cards (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  board_id BIGINT NOT NULL,
  column_id BIGINT NOT NULL,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  locked BOOLEAN NOT NULL DEFAULT FALSE,
  CONSTRAINT fk_cards_board FOREIGN KEY (board_id) REFERENCES boards(id) ON DELETE CASCADE,
  CONSTRAINT fk_cards_column FOREIGN KEY (column_id) REFERENCES columns(id) ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS card_movements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  card_id BIGINT NOT NULL,
  from_column_id BIGINT NULL,
  to_column_id BIGINT NOT NULL,
  entered_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  left_at TIMESTAMP NULL,
  CONSTRAINT fk_mov_card FOREIGN KEY (card_id) REFERENCES cards(id) ON DELETE CASCADE,
  CONSTRAINT fk_mov_from FOREIGN KEY (from_column_id) REFERENCES columns(id) ON DELETE SET NULL,
  CONSTRAINT fk_mov_to FOREIGN KEY (to_column_id) REFERENCES columns(id) ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS card_blocks (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  card_id BIGINT NOT NULL,
  blocked_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  unblocked_at TIMESTAMP NULL,
  block_reason VARCHAR(400) NOT NULL,
  unblock_reason VARCHAR(400),
  CONSTRAINT fk_blk_card FOREIGN KEY (card_id) REFERENCES cards(id) ON DELETE CASCADE
);